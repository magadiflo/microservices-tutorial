# Order Service

En esta secci贸n abordaremos los siguientes temas:

- Creaci贸n de un servicio de pedidos.
- Migraciones de bases de datos con `Flyway`.
- Escritura de pruebas de integraci贸n usando `Testcontainers`.

---

## Dependencias

Creamos el microservicio de `order service` a trav茅s de
[Spring Initializr](https://start.spring.io/#!type=maven-project&language=java&platformVersion=3.5.9&packaging=jar&configurationFileFormat=yaml&jvmVersion=21&groupId=dev.magadiflo&artifactId=order-service&name=order-service&description=Demo%20project%20for%20Spring%20Boot&packageName=dev.magadiflo.order.app&dependencies=lombok,actuator,web,data-jpa,mysql,testcontainers,flyway)
con las siguientes dependencias.

````xml
<!--Spring Boot 3.5.9-->
<!--Java 21-->
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-core</artifactId>
    </dependency>
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-mysql</artifactId>
    </dependency>

    <dependency>
        <groupId>com.mysql</groupId>
        <artifactId>mysql-connector-j</artifactId>
        <scope>runtime</scope>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-testcontainers</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.testcontainers</groupId>
        <artifactId>junit-jupiter</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.testcontainers</groupId>
        <artifactId>mysql</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
````

Es importante tener en cuenta que, al crear el proyecto, Spring Boot genera autom谩ticamente varias clases de soporte
para las pruebas. Entre ellas se encuentra la clase `TestcontainersConfiguration`, ubicada en el directorio
`src/test/java/dev/magadiflo/order/app`.

Esta clase se crea de forma autom谩tica porque hemos agregado la dependencia `spring-boot-testcontainers`, la cual
facilita la integraci贸n de `Testcontainers` con el contexto de pruebas de Spring Boot.

Por defecto, la clase `TestcontainersConfiguration` viene configurada para utilizar la imagen `mysql:latest`,
ya que `Spring Boot` detecta el uso de `Testcontainers` junto con el m贸dulo `org.testcontainers:mysql`. Sin embargo,
en mi caso ya cuento localmente con la imagen `mysql:8.0.41-debian` en Docker, por lo que he decidido modificar esta
configuraci贸n para reutilizar dicha imagen y evitar la descarga innecesaria de otra versi贸n.

A continuaci贸n, se muestra la clase ajustada para utilizar expl铆citamente la imagen deseada:

````java

@TestConfiguration(proxyBeanMethods = false)
class TestcontainersConfiguration {

    @Bean
    @ServiceConnection
    MySQLContainer<?> mysqlContainer() {
        return new MySQLContainer<>(DockerImageName.parse("mysql:8.0.41-debian"));
    }

}
````

 `Nota`: Reutilizar im谩genes ya disponibles en el entorno local permite reducir el tiempo de ejecuci贸n de las pruebas
y optimizar el uso de recursos, especialmente en entornos de desarrollo o pipelines de CI donde las pruebas se ejecutan
con frecuencia.

锔 Explicaci贸n t茅cnica:
> La anotaci贸n `@ServiceConnection` permite que Spring Boot configure autom谩ticamente las propiedades de conexi贸n (URL,
> usuario, contrase帽a, etc.) del contenedor de MySQL, evitando configuraciones manuales adicionales en los archivos de
> propiedades de test.
